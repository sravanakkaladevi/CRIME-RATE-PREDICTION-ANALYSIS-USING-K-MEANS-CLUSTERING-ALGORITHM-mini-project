{% extends 'base.html' %}
{% load static %}
{% block content %}

<style>
body {
  background: url("{% static 'images/pexels-cottonbro-8369520.jpg' %}") center/cover fixed no-repeat;
  color: #fff;
}
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.88);
  backdrop-filter: blur(7px);
  z-index: -1;
}

.analysis-box {
  background: rgba(0,0,0,0.7);
  border: 1px solid rgba(0,255,255,0.25);
  border-radius: 18px;
  padding: 35px;
  margin: 50px auto;
  max-width: 1300px;
  text-align: center;
  box-shadow: 0 0 25px rgba(0,255,255,0.25);
}

.graph-img {
  width: 100%;
  height: 280px !important;
  object-fit: cover;
  border-radius: 16px;
  cursor: zoom-in;
  transition: .3s ease;
}
.graph-img:hover {
  transform: scale(1.03);
  box-shadow: 0 0 25px cyan;
}
</style>

<div class="analysis-box">

  <h2>ğŸ“Š Crime Analysis Dashboard</h2>
  <div class="underline-glow"></div>

  <!-- ====== 3 GRAPHS ====== -->
  <div class="row justify-content-center mt-4">
    {% for name, path in graphs.items %}
    <div class="col-md-4 mb-4">
      <img src="{{ path }}" class="graph-img" alt="{{ name }}" onclick="openFullscreen(this)">
      <p class="text-light mt-2">{{ name }}</p>
    </div>
    {% endfor %}
  </div>

  <!-- ====== STATIC HEATMAP ====== -->
  {% if heatmap %}
  <div class="text-center mt-5">
      <h4 class="text-light">ğŸ”¥ Crime Density Heatmap (Static)</h4>

      <img src="{{ heatmap }}" class="img-fluid rounded shadow-lg"
           style="max-height:450px; object-fit:contain; cursor:zoom-in;"
           onclick="openFullscreen(this)">
  </div>
  {% endif %}

  <!-- ====== STATE ZOOM FORM ====== -->
  <form method="POST" class="mb-4 mt-5" style="max-width:400px; margin:auto;">
      {% csrf_token %}
      <label class="text-light mb-2" style="font-size:1.1rem;">ğŸ¯ Select State to Zoom</label>

      <select name="state" class="form-select mb-2" style="border-radius:10px;">
          <option value="ALL" selected>ALL (Show Full Map)</option>

          {% for s in crime_levels.high %}
            <option>{{ s }}</option>
          {% endfor %}
          {% for s in crime_levels.medium %}
            <option>{{ s }}</option>
          {% endfor %}
          {% for s in crime_levels.low %}
            <option>{{ s }}</option>
          {% endfor %}
      </select>

      <button type="submit" class="btn btn-primary mt-2" style="border-radius:10px;">ğŸ” Zoom</button>
  </form>

  <!-- ====== INTERACTIVE MAP ====== -->
  {% if choropleth %}
  <div id="mapSection" class="text-center mt-5">
      <h4 class="text-light">ğŸ—ºï¸ India Crime Heatmap (Interactive)</h4>

      <iframe src="{{ choropleth }}" width="100%" height="850px"
              style="border:none; border-radius:16px;
              box-shadow:0 0 25px rgba(0,255,255,0.4);"></iframe>
  </div>
  {% endif %}

  <!-- ====== CRIME LEVEL LIST ====== -->
  <div class="text-start mt-5 p-4 rounded"
       style="background:rgba(255,255,255,0.05);
              border:1px solid rgba(0,255,255,0.25);">

    <h3 class="text-light mb-3">ğŸ“Œ Crime Category by State</h3>

    <h4 style="color:#ff4d4d;">ğŸ”´ High Crime States</h4>
    <ul class="text-light">
        {% for s in crime_levels.high %}
        <li>{{ s }}</li>
        {% endfor %}
    </ul>

    <h4 style="color:#ffcc00;">ğŸŸ  Medium Crime States</h4>
    <ul class="text-light">
        {% for s in crime_levels.medium %}
        <li>{{ s }}</li>
        {% endfor %}
    </ul>

    <h4 style="color:#00ff88;">ğŸŸ¢ Low Crime States</h4>
    <ul class="text-light">
        {% for s in crime_levels.low %}
        <li>{{ s }}</li>
        {% endfor %}
    </ul>

  </div>

  <!-- ====== TABLE ====== -->
  <h4 class="text-light mt-5">ğŸ§¾ Dataset Preview</h4>
  <div class="table-container" id="tableContainer">
    {{ table|safe }}
  </div>

</div>

<!-- FULLSCREEN IMAGE -->
<script>
function openFullscreen(img) {
  let overlay = document.createElement("div");
  overlay.style = `
      position:fixed; inset:0;
      background:rgba(0,0,0,0.9);
      display:flex; justify-content:center; align-items:center;
      z-index:9999; cursor:zoom-out;
  `;
  let fullImg = document.createElement("img");
  fullImg.src = img.src;
  fullImg.style = `
      max-width:95%; max-height:95%;
      border-radius:12px; box-shadow:0 0 30px cyan;
  `;
  overlay.appendChild(fullImg);
  overlay.onclick = () => overlay.remove();
  document.body.appendChild(overlay);
}
</script>

<!-- AUTO SCROLL ON POST -->
{% if request.method == "POST" %}
<script>
setTimeout(() => {
  const section = document.getElementById("mapSection");
  if (section) section.scrollIntoView({ behavior: "smooth" });
}, 400);
</script>
{% endif %}

{% endblock %}
